name: Build and release

on:
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: false
        type: choice
        default: patch
        options:
          - patch
          - minor
          - major

env:
  REGISTRY: ghcr.io
  IMAGE_DESCRIPTION: ACM Certificate Controller for Kubernetes

jobs:
  prepare-build:
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.version.outputs.version }}
      name_lower: ${{ steps.repo.outputs.name_lower }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
        fetch-tags: true

    - name: Generate version
      id: version
      run: |
        BUMP="${{ github.event.inputs.bump }}"

        # Get the latest semver tag
        LATEST_TAG=$(git tag -l "v[0-9]*.[0-9]*.[0-9]*" | sort -V | tail -n 1)

        if [ -z "$LATEST_TAG" ]; then
          VERSION="0.1.0"
        else
          # Strip leading 'v'
          CURRENT="${LATEST_TAG#v}"
          MAJOR=$(echo "$CURRENT" | cut -d. -f1)
          MINOR=$(echo "$CURRENT" | cut -d. -f2)
          PATCH=$(echo "$CURRENT" | cut -d. -f3)

          case "$BUMP" in
            major) VERSION="$((MAJOR + 1)).0.0" ;;
            minor) VERSION="${MAJOR}.$((MINOR + 1)).0" ;;
            *)     VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))" ;;
          esac
        fi

        echo "Generated version: $VERSION"
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Convert repository name to lowercase
      id: repo
      run: |
        REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
        echo "name_lower=$REPO_LOWER" >> $GITHUB_OUTPUT

  build-multiarch-images:
    needs: prepare-build

    permissions:
      contents: read
      packages: write

    strategy:
      fail-fast: false
      matrix:
        platform:
        - linux/amd64
        - linux/arm64

    runs-on: ${{ matrix.platform == 'linux/amd64' && 'ubuntu-latest' || 'ubuntu-24.04-arm' }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        platforms: ${{ matrix.platform }}

    - name: Generate Docker metadata and labels
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ needs.prepare-build.outputs.name_lower }}
        tags: |
          type=raw,value=${{ needs.prepare-build.outputs.version }}-${{ matrix.platform == 'linux/amd64' && 'amd64' || 'arm64' }}
        labels: |
          org.opencontainers.image.title=ACM Certificate Controller
          org.opencontainers.image.description=${{ env.IMAGE_DESCRIPTION }} (${{ matrix.platform }})
          org.opencontainers.image.version=${{ needs.prepare-build.outputs.version }}
          org.opencontainers.image.vendor=${{ github.repository_owner }}
          org.opencontainers.image.source=https://github.com/${{ github.repository }}
          org.opencontainers.image.url=https://github.com/${{ github.repository }}
          org.opencontainers.image.revision=${{ github.sha }}

    - name: Build and push platform-specific image
      uses: docker/build-push-action@v6
      env:
        DOCKER_BUILD_SUMMARY: false
      with:
        context: .
        platforms: ${{ matrix.platform }}
        push: true
        provenance: false
        sbom: false
        tags: ${{ steps.meta.outputs.tags }}
        annotations: ${{ steps.meta.outputs.annotations }}
        labels: ${{ steps.meta.outputs.labels }}
        outputs: type=image,oci-mediatypes=true

  create-multiarch-manifest:
    needs:
    - prepare-build
    - build-multiarch-images

    permissions:
      contents: read
      packages: write

    runs-on: ubuntu-latest

    steps:
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Create multiarch manifest and push
      run: |
        VERSION="${{ needs.prepare-build.outputs.version }}"
        docker buildx imagetools create \
          -t ${{ env.REGISTRY }}/${{ needs.prepare-build.outputs.name_lower }}:${VERSION} \
          -t ${{ env.REGISTRY }}/${{ needs.prepare-build.outputs.name_lower }}:latest \
          --annotation='index:org.opencontainers.image.title=ACM Certificate Controller' \
          --annotation='index:org.opencontainers.image.description=${{ env.IMAGE_DESCRIPTION }}' \
          --annotation='index:org.opencontainers.image.version=${VERSION}' \
          --annotation='index:org.opencontainers.image.vendor=${{ github.repository_owner }}' \
          --annotation='index:org.opencontainers.image.source=https://github.com/${{ github.repository }}' \
          --annotation='index:org.opencontainers.image.url=https://github.com/${{ github.repository }}' \
          --annotation='index:org.opencontainers.image.revision=${{ github.sha }}' \
          ${{ env.REGISTRY }}/${{ needs.prepare-build.outputs.name_lower }}:${VERSION}-amd64 \
          ${{ env.REGISTRY }}/${{ needs.prepare-build.outputs.name_lower }}:${VERSION}-arm64

    - name: Inspect multiarch manifest
      run: |
        docker buildx imagetools inspect '${{ env.REGISTRY }}/${{ needs.prepare-build.outputs.name_lower }}:${{ needs.prepare-build.outputs.version }}'

  publish-github-release:
    needs:
    - prepare-build
    - create-multiarch-manifest

    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
        fetch-tags: true

    - name: Create GitHub Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        VERSION: ${{ needs.prepare-build.outputs.version }}
      run: |
        gh release create "v${VERSION}" \
          --title "Release ${VERSION}" \
          --generate-notes
